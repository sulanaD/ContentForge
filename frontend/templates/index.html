<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI Workflow Orchestrator</title>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Inter', sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            color: #333;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
        }

        .header {
            text-align: center;
            margin-bottom: 40px;
            color: white;
        }

        .header h1 {
            font-size: 3em;
            font-weight: 700;
            margin-bottom: 10px;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.3);
        }

        .header p {
            font-size: 1.2em;
            opacity: 0.9;
            font-weight: 300;
        }

        .main-content {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 30px;
            margin-bottom: 40px;
        }

        @media (max-width: 768px) {
            .main-content {
                grid-template-columns: 1fr;
            }
        }

        .card {
            background: white;
            border-radius: 20px;
            padding: 30px;
            box-shadow: 0 20px 40px rgba(0,0,0,0.1);
            transition: transform 0.3s ease, box-shadow 0.3s ease;
        }

        .card:hover {
            transform: translateY(-5px);
            box-shadow: 0 25px 50px rgba(0,0,0,0.15);
        }

        .card h2 {
            font-size: 1.8em;
            margin-bottom: 20px;
            color: #4a5568;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .form-group {
            margin-bottom: 20px;
        }

        .form-group label {
            display: block;
            font-weight: 600;
            margin-bottom: 8px;
            color: #4a5568;
            font-size: 0.95em;
        }

        .form-group input,
        .form-group select,
        .form-group textarea {
            width: 100%;
            padding: 12px 16px;
            border: 2px solid #e2e8f0;
            border-radius: 12px;
            font-size: 16px;
            transition: border-color 0.3s ease, box-shadow 0.3s ease;
            font-family: inherit;
        }

        .form-group input:focus,
        .form-group select:focus,
        .form-group textarea:focus {
            outline: none;
            border-color: #667eea;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        }

        .form-group textarea {
            resize: vertical;
            min-height: 100px;
        }

        .form-row {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px;
        }

        @media (max-width: 600px) {
            .form-row {
                grid-template-columns: 1fr;
            }
        }

        .btn {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            padding: 15px 30px;
            font-size: 1.1em;
            font-weight: 600;
            border-radius: 12px;
            cursor: pointer;
            transition: all 0.3s ease;
            display: inline-flex;
            align-items: center;
            gap: 10px;
            text-decoration: none;
            width: 100%;
            justify-content: center;
        }

        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 25px rgba(102, 126, 234, 0.3);
        }

        .btn:active {
            transform: translateY(0);
        }

        .btn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            transform: none;
            box-shadow: none;
        }

        .workflow-status {
            background: white;
            border-radius: 20px;
            padding: 30px;
            box-shadow: 0 20px 40px rgba(0,0,0,0.1);
            margin-top: 30px;
            display: none;
        }

        .workflow-status.active {
            display: block;
        }

        .status-header {
            display: flex;
            justify-content: between;
            align-items: center;
            margin-bottom: 20px;
        }

        .status-badge {
            padding: 8px 16px;
            border-radius: 20px;
            font-weight: 600;
            font-size: 0.9em;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .status-badge.running {
            background: #fef3cd;
            color: #8a6914;
        }

        .status-badge.completed {
            background: #d1ecf1;
            color: #0c5460;
        }

        .status-badge.failed {
            background: #f8d7da;
            color: #721c24;
        }

        .progress-bar {
            width: 100%;
            height: 8px;
            background: #e2e8f0;
            border-radius: 4px;
            margin: 20px 0;
            overflow: hidden;
        }

        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, #667eea, #764ba2);
            transition: width 0.3s ease;
            border-radius: 4px;
        }

        .workflow-steps {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(120px, 1fr));
            gap: 15px;
            margin: 20px 0;
        }

        .workflow-step {
            background: #f8fafc;
            border: 2px solid #e2e8f0;
            border-radius: 12px;
            padding: 15px;
            text-align: center;
            transition: all 0.3s ease;
        }

        .workflow-step.active {
            border-color: #667eea;
            background: #f0f4ff;
        }

        .workflow-step.completed {
            border-color: #48bb78;
            background: #f0fff4;
        }

        .workflow-step i {
            font-size: 1.5em;
            margin-bottom: 8px;
        }

        .workflow-step.active i {
            color: #667eea;
            animation: pulse 2s infinite;
        }

        .workflow-step.completed i {
            color: #48bb78;
        }

        @keyframes pulse {
            0% { opacity: 1; }
            50% { opacity: 0.5; }
            100% { opacity: 1; }
        }

        .result-section {
            margin-top: 30px;
            padding: 25px;
            background: #f8fafc;
            border-radius: 15px;
            border-left: 4px solid #667eea;
        }

        .result-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }

        .result-stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-bottom: 20px;
        }

        .stat-card {
            background: white;
            padding: 20px;
            border-radius: 12px;
            text-align: center;
            box-shadow: 0 4px 6px rgba(0,0,0,0.05);
        }

        .stat-value {
            font-size: 2em;
            font-weight: 700;
            color: #667eea;
        }

        .stat-label {
            font-size: 0.9em;
            color: #718096;
            margin-top: 5px;
        }

        .content-preview {
            background: white;
            border: 2px solid #e2e8f0;
            border-radius: 12px;
            padding: 20px;
            max-height: 300px;
            overflow-y: auto;
            font-family: 'Courier New', monospace;
            font-size: 0.9em;
            line-height: 1.6;
        }

        .workflow-history {
            margin-top: 40px;
        }

        .history-item {
            background: white;
            border-radius: 15px;
            padding: 20px;
            margin-bottom: 15px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.05);
            display: flex;
            justify-content: space-between;
            align-items: center;
            transition: transform 0.2s ease;
        }

        .history-item:hover {
            transform: translateX(5px);
        }

        .history-info {
            flex: 1;
        }

        .history-topic {
            font-weight: 600;
            color: #4a5568;
            margin-bottom: 5px;
        }

        .history-meta {
            font-size: 0.9em;
            color: #718096;
        }

        .history-actions {
            display: flex;
            gap: 10px;
        }

        .btn-small {
            padding: 8px 16px;
            font-size: 0.9em;
            border-radius: 8px;
        }

        .btn-secondary {
            background: #f8fafc;
            color: #4a5568;
            border: 2px solid #e2e8f0;
        }

        .btn-secondary:hover {
            background: #e2e8f0;
        }

        .loading {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 3px solid rgba(255,255,255,.3);
            border-radius: 50%;
            border-top-color: #fff;
            animation: spin 1s ease-in-out infinite;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        .notification {
            position: fixed;
            top: 20px;
            right: 20px;
            background: white;
            border-radius: 12px;
            padding: 20px;
            box-shadow: 0 10px 25px rgba(0,0,0,0.15);
            display: none;
            z-index: 1000;
            max-width: 400px;
        }

        .notification.show {
            display: block;
            animation: slideIn 0.3s ease;
        }

        @keyframes slideIn {
            from { transform: translateX(100%); opacity: 0; }
            to { transform: translateX(0); opacity: 1; }
        }

        .notification.success {
            border-left: 4px solid #48bb78;
        }

        .notification.error {
            border-left: 4px solid #f56565;
        }

        .advanced-options {
            margin-top: 20px;
            padding: 20px;
            background: #f8fafc;
            border-radius: 12px;
            border: 2px dashed #e2e8f0;
        }

        .advanced-toggle {
            background: none;
            border: none;
            color: #667eea;
            font-weight: 600;
            cursor: pointer;
            padding: 0;
            text-decoration: underline;
        }

        .advanced-content {
            margin-top: 15px;
            display: none;
        }

        .advanced-content.show {
            display: block;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1><i class="fas fa-robot"></i> AI Workflow Orchestrator</h1>
            <p>Create amazing content with our intelligent multi-agent system</p>
        </div>

        <div class="main-content">
            <!-- Content Creation Form -->
            <div class="card">
                <h2><i class="fas fa-pencil-alt"></i> Create Content</h2>
                <form id="workflowForm">
                    <div class="form-group">
                        <label for="topic">Content Topic *</label>
                        <input type="text" id="topic" name="topic" required 
                               placeholder="e.g., Benefits of AI in Healthcare">
                    </div>

                    <div class="form-row">
                        <div class="form-group">
                            <label for="workflowType">Workflow Type *</label>
                            <select id="workflowType" name="workflow_type" required>
                                <option value="">Select workflow...</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label for="contentType">Content Type *</label>
                            <select id="contentType" name="content_type" required>
                                <option value="">Select type...</option>
                            </select>
                        </div>
                    </div>

                    <div class="form-group">
                        <label for="targetAudience">Target Audience</label>
                        <input type="text" id="targetAudience" name="target_audience" 
                               placeholder="e.g., Healthcare professionals, beginners">
                    </div>

                    <div class="advanced-options">
                        <button type="button" class="advanced-toggle" onclick="toggleAdvanced()">
                            <i class="fas fa-cog"></i> Advanced Options
                        </button>
                        <div class="advanced-content" id="advancedContent">
                            <div class="form-row">
                                <div class="form-group">
                                    <label for="focusKeyword">Focus Keyword</label>
                                    <input type="text" id="focusKeyword" name="focus_keyword" 
                                           placeholder="Main SEO keyword">
                                </div>
                                <div class="form-group">
                                    <label for="wordCount">Target Word Count</label>
                                    <input type="number" id="wordCount" name="word_count" 
                                           placeholder="500" min="100" max="5000">
                                </div>
                            </div>
                            <div class="form-group">
                                <label for="targetKeywords">Target Keywords</label>
                                <input type="text" id="targetKeywords" name="target_keywords" 
                                       placeholder="keyword1, keyword2, keyword3">
                            </div>
                            <div class="form-row">
                                <div class="form-group">
                                    <label for="tone">Content Tone</label>
                                    <select id="tone" name="tone">
                                        <option value="">Auto-select</option>
                                        <option value="professional">Professional</option>
                                        <option value="casual">Casual</option>
                                        <option value="conversational">Conversational</option>
                                        <option value="academic">Academic</option>
                                        <option value="friendly">Friendly</option>
                                    </select>
                                </div>
                                <div class="form-group">
                                    <label for="targetPlatform">Target Platform</label>
                                    <select id="targetPlatform" name="target_platform">
                                        <option value="">Any platform</option>
                                        <option value="wordpress">WordPress</option>
                                        <option value="medium">Medium</option>
                                        <option value="linkedin">LinkedIn</option>
                                        <option value="facebook">Facebook</option>
                                        <option value="twitter">Twitter</option>
                                    </select>
                                </div>
                            </div>
                        </div>
                    </div>

                    <button type="submit" class="btn" id="startBtn">
                        <i class="fas fa-play"></i> Start Workflow
                    </button>
                </form>
            </div>

            <!-- Workflow Information -->
            <div class="card">
                <h2><i class="fas fa-info-circle"></i> How It Works</h2>
                <div class="workflow-steps">
                    <div class="workflow-step">
                        <i class="fas fa-search"></i>
                        <div>Research</div>
                    </div>
                    <div class="workflow-step">
                        <i class="fas fa-edit"></i>
                        <div>Write</div>
                    </div>
                    <div class="workflow-step">
                        <i class="fas fa-user-friends"></i>
                        <div>Humanize</div>
                    </div>
                    <div class="workflow-step">
                        <i class="fas fa-spell-check"></i>
                        <div>Edit</div>
                    </div>
                    <div class="workflow-step">
                        <i class="fas fa-chart-line"></i>
                        <div>SEO</div>
                    </div>
                </div>
                
                <p style="color: #718096; line-height: 1.6; margin-top: 20px;">
                    Our AI agents work together to create high-quality content. The Research agent 
                    gathers information, the Writer creates structured content, the Humanization 
                    agent makes it natural and engaging, the Editor improves quality, and the 
                    SEO agent optimizes for search engines.
                </p>

                <div style="margin-top: 25px; padding: 20px; background: #f0f4ff; border-radius: 12px;">
                    <h4 style="color: #667eea; margin-bottom: 10px;">
                        <i class="fas fa-lightbulb"></i> Quick Start Tips
                    </h4>
                    <ul style="color: #4a5568; line-height: 1.8; padding-left: 20px;">
                        <li>Be specific with your topic for better results</li>
                        <li>Choose the right workflow for your needs</li>
                        <li>Add focus keywords for SEO optimization</li>
                        <li>Monitor real-time progress in the status panel</li>
                    </ul>
                </div>
            </div>
        </div>

        <!-- Workflow Status Section -->
        <div class="workflow-status" id="workflowStatus">
            <div class="status-header">
                <h2><i class="fas fa-tasks"></i> Workflow Progress</h2>
                <div class="status-badge" id="statusBadge">Starting</div>
            </div>
            
            <div class="progress-bar">
                <div class="progress-fill" id="progressFill" style="width: 0%"></div>
            </div>
            
            <div class="workflow-steps" id="workflowSteps">
                <!-- Steps will be populated dynamically -->
            </div>
            
            <div id="statusMessage" style="margin: 20px 0; color: #4a5568; font-weight: 500;"></div>
            
            <!-- Results Section -->
            <div class="result-section" id="resultSection" style="display: none;">
                <div class="result-header">
                    <h3><i class="fas fa-check-circle"></i> Results</h3>
                    <button class="btn btn-small" id="downloadBtn">
                        <i class="fas fa-download"></i> Download
                    </button>
                </div>
                
                <div class="result-stats" id="resultStats">
                    <!-- Stats will be populated dynamically -->
                </div>
                
                <div class="content-preview" id="contentPreview">
                    <!-- Content preview will be shown here -->
                </div>
            </div>
        </div>

        <!-- Workflow History -->
        <div class="workflow-history">
            <h2 style="color: white; margin-bottom: 20px;">
                <i class="fas fa-history"></i> Recent Workflows
            </h2>
            <div id="workflowHistory">
                <!-- History items will be populated dynamically -->
            </div>
        </div>
    </div>

    <!-- Notification -->
    <div class="notification" id="notification">
        <div id="notificationContent"></div>
    </div>

    <!-- Scripts -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/4.7.2/socket.io.js"></script>
    <script>
        // Global variables
        let socket;
        let currentWorkflowId = null;
        let pollingInterval = null;
        let isConnected = false;

        // Initialize the application
        document.addEventListener('DOMContentLoaded', function() {
            initializeSocket();
            loadWorkflowTypes();
            loadContentTypes();
            loadWorkflowHistory();
            setupFormHandling();
        });

        function initializeSocket() {
            console.log('üîå Initializing WebSocket connection...');
            
            socket = io({
                transports: ['websocket', 'polling'],
                reconnection: true,
                reconnectionAttempts: 10,
                reconnectionDelay: 1000
            });
            
            socket.on('connect', function() {
                console.log('‚úÖ Connected to server via WebSocket');
                isConnected = true;
                showNotification('Connected to server', 'success');
            });

            socket.on('disconnect', function() {
                console.log('‚ùå Disconnected from server');
                isConnected = false;
                showNotification('Disconnected from server, reconnecting...', 'error');
            });

            socket.on('reconnect', function(attemptNumber) {
                console.log('üîÑ Reconnected after ' + attemptNumber + ' attempts');
                isConnected = true;
                showNotification('Reconnected to server', 'success');
            });

            socket.on('workflow_update', function(data) {
                console.log('üì® Received workflow update:', data);
                updateWorkflowProgress(data);
            });

            socket.on('connected', function(data) {
                console.log('ü§ù Server acknowledged connection:', data);
            });

            socket.on('error', function(error) {
                console.error('‚ùå Socket error:', error);
            });
        }

        // Fallback polling for workflow status
        function startPolling(workflowId) {
            console.log('üìä Starting polling for workflow:', workflowId);
            
            // Clear any existing polling
            if (pollingInterval) {
                clearInterval(pollingInterval);
            }
            
            // Poll every 2 seconds
            pollingInterval = setInterval(async () => {
                try {
                    const response = await fetch(`/api/workflow/${workflowId}`);
                    if (response.ok) {
                        const data = await response.json();
                        console.log('üìä Polling update:', data);
                        
                        // Update the UI
                        updateWorkflowProgressFromAPI(data);
                        
                        // Stop polling if completed or failed
                        if (data.status === 'completed' || data.status === 'failed') {
                            console.log('üèÅ Workflow finished, stopping polling');
                            clearInterval(pollingInterval);
                            pollingInterval = null;
                        }
                    }
                } catch (error) {
                    console.error('Polling error:', error);
                }
            }, 2000);
        }

        function stopPolling() {
            if (pollingInterval) {
                clearInterval(pollingInterval);
                pollingInterval = null;
            }
        }

        function updateWorkflowProgressFromAPI(data) {
            // Update status badge
            const statusBadge = document.getElementById('statusBadge');
            statusBadge.textContent = data.status.charAt(0).toUpperCase() + data.status.slice(1);
            statusBadge.className = `status-badge ${data.status}`;
            
            // Update progress bar
            const progressFill = document.getElementById('progressFill');
            progressFill.style.width = `${data.progress}%`;
            
            // Update status message based on status
            const statusMessage = document.getElementById('statusMessage');
            if (data.status === 'running') {
                statusMessage.textContent = 'Workflow is running... Please wait.';
            } else if (data.status === 'completed') {
                statusMessage.textContent = 'Workflow completed successfully!';
                // Fetch full result and show it
                if (data.result) {
                    showResults(data.result);
                } else {
                    fetchAndShowResults(data.id);
                }
                loadWorkflowHistory();
            } else if (data.status === 'failed') {
                statusMessage.textContent = `Workflow failed: ${data.error || 'Unknown error'}`;
            }
        }

        async function fetchAndShowResults(workflowId) {
            try {
                const response = await fetch(`/api/workflow/${workflowId}`);
                if (response.ok) {
                    const data = await response.json();
                    if (data.result) {
                        showResults(data.result);
                    }
                }
            } catch (error) {
                console.error('Failed to fetch results:', error);
            }
        }

        async function loadWorkflowTypes() {
            try {
                const response = await fetch('/api/workflow-types');
                const data = await response.json();
                
                const select = document.getElementById('workflowType');
                select.innerHTML = '<option value="">Select workflow...</option>';
                
                for (const [key, workflow] of Object.entries(data.workflow_types)) {
                    const option = document.createElement('option');
                    option.value = key;
                    option.textContent = `${workflow.name} (${workflow.estimated_time})`;
                    option.title = workflow.description;
                    select.appendChild(option);
                }
            } catch (error) {
                showNotification('Failed to load workflow types', 'error');
            }
        }

        async function loadContentTypes() {
            try {
                const response = await fetch('/api/content-types');
                const data = await response.json();
                
                const select = document.getElementById('contentType');
                select.innerHTML = '<option value="">Select type...</option>';
                
                for (const [key, type] of Object.entries(data.content_types)) {
                    const option = document.createElement('option');
                    option.value = key;
                    option.textContent = type.name;
                    option.title = type.description;
                    select.appendChild(option);
                }
            } catch (error) {
                showNotification('Failed to load content types', 'error');
            }
        }

        function setupFormHandling() {
            const form = document.getElementById('workflowForm');
            form.addEventListener('submit', async function(e) {
                e.preventDefault();
                
                const formData = new FormData(form);
                const data = Object.fromEntries(formData);
                
                // Validate required fields
                if (!data.topic || !data.workflow_type || !data.content_type) {
                    showNotification('Please fill in all required fields', 'error');
                    return;
                }
                
                try {
                    const startBtn = document.getElementById('startBtn');
                    startBtn.disabled = true;
                    startBtn.innerHTML = '<div class="loading"></div> Starting...';
                    
                    const response = await fetch('/api/start-workflow', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify(data)
                    });
                    
                    const result = await response.json();
                    
                    if (result.success) {
                        currentWorkflowId = result.workflow_id;
                        showWorkflowStatus();
                        showNotification('Workflow started successfully!', 'success');
                        
                        // Start polling as a backup for WebSocket updates
                        startPolling(currentWorkflowId);
                        
                        form.reset();
                    } else {
                        throw new Error(result.error || 'Failed to start workflow');
                    }
                } catch (error) {
                    showNotification(`Error: ${error.message}`, 'error');
                } finally {
                    const startBtn = document.getElementById('startBtn');
                    startBtn.disabled = false;
                    startBtn.innerHTML = '<i class="fas fa-play"></i> Start Workflow';
                }
            });
        }

        function showWorkflowStatus() {
            const statusSection = document.getElementById('workflowStatus');
            statusSection.classList.add('active');
            statusSection.scrollIntoView({ behavior: 'smooth' });
        }

        function updateWorkflowProgress(data) {
            console.log('üîÑ Processing workflow update for:', data.workflow_id);
            
            // Accept updates for current workflow or if no current workflow is set
            if (currentWorkflowId && data.workflow_id !== currentWorkflowId) {
                console.log('‚è≠Ô∏è Skipping update for different workflow');
                return;
            }
            
            // Update current workflow ID if not set
            if (!currentWorkflowId) {
                currentWorkflowId = data.workflow_id;
            }
            
            // Update status badge
            const statusBadge = document.getElementById('statusBadge');
            if (statusBadge) {
                statusBadge.textContent = data.status.charAt(0).toUpperCase() + data.status.slice(1);
                statusBadge.className = `status-badge ${data.status}`;
            }
            
            // Update progress bar
            const progressFill = document.getElementById('progressFill');
            if (progressFill) {
                progressFill.style.width = `${data.progress}%`;
            }
            
            // Update status message
            const statusMessage = document.getElementById('statusMessage');
            if (statusMessage) {
                statusMessage.textContent = data.message || 'Processing...';
            }
            
            // Handle completion
            if (data.status === 'completed') {
                console.log('‚úÖ Workflow completed!');
                stopPolling();
                
                if (data.result) {
                    showResults(data.result);
                } else {
                    // Fetch results if not included
                    fetchAndShowResults(data.workflow_id);
                }
                loadWorkflowHistory();
                showNotification('Content created successfully!', 'success');
            }
            
            // Handle failure
            if (data.status === 'failed') {
                console.log('‚ùå Workflow failed:', data.message);
                stopPolling();
                showNotification(data.message || 'Workflow failed', 'error');
            }
        }

        function showResults(result) {
            console.log('üìä Showing results:', result);
            
            const resultSection = document.getElementById('resultSection');
            const resultStats = document.getElementById('resultStats');
            const contentPreview = document.getElementById('contentPreview');
            
            if (!resultSection || !resultStats || !contentPreview) {
                console.error('Result elements not found');
                return;
            }
            
            // Get output from result
            const output = result.output || result;
            
            // Create stats with safe access
            const wordCount = output.content ? output.content.split(/\s+/).filter(w => w.length > 0).length : 0;
            const seoScore = output.seo_score ? Math.round(output.seo_score) : null;
            const agentsUsed = result.execution_log ? Object.keys(result.execution_log).length : 'N/A';
            
            const stats = [
                { label: 'Word Count', value: wordCount || 'N/A' },
                { label: 'SEO Score', value: seoScore ? `${seoScore}/100` : 'N/A' },
                { label: 'Agents Used', value: agentsUsed },
                { label: 'Status', value: '‚úÖ Complete' }
            ];
            
            resultStats.innerHTML = stats.map(stat => `
                <div class="stat-card">
                    <div class="stat-value">${stat.value}</div>
                    <div class="stat-label">${stat.label}</div>
                </div>
            `).join('');
            
            // Show content preview
            let previewContent = '';
            if (output.seo_title) {
                previewContent += `# ${output.seo_title}\n\n`;
            } else if (output.title) {
                previewContent += `# ${output.title}\n\n`;
            }
            if (output.seo_meta_description) {
                previewContent += `**Meta:** ${output.seo_meta_description}\n\n`;
            }
            if (output.url_slug) {
                previewContent += `**URL:** /${output.url_slug}\n\n`;
            }
            previewContent += '---\n\n';
            
            if (output.content) {
                // Show full content or truncate if very long
                const maxPreviewLength = 2000;
                if (output.content.length > maxPreviewLength) {
                    previewContent += output.content.substring(0, maxPreviewLength) + '\n\n... (content truncated, download for full version)';
                } else {
                    previewContent += output.content;
                }
            } else {
                previewContent += 'No content available';
            }
            
            contentPreview.textContent = previewContent;
            
            // Setup download button
            const downloadBtn = document.getElementById('downloadBtn');
            if (downloadBtn && currentWorkflowId) {
                downloadBtn.onclick = () => downloadContent(currentWorkflowId);
                downloadBtn.style.display = 'inline-flex';
            }
            
            // Show result section with animation
            resultSection.style.display = 'block';
            resultSection.scrollIntoView({ behavior: 'smooth', block: 'center' });
        }

        async function loadWorkflowHistory() {
            try {
                const response = await fetch('/api/workflows');
                const data = await response.json();
                
                const historyContainer = document.getElementById('workflowHistory');
                
                if (data.workflows.length === 0) {
                    historyContainer.innerHTML = `
                        <div class="history-item">
                            <div class="history-info">
                                <div class="history-topic">No workflows yet</div>
                                <div class="history-meta">Start your first workflow above!</div>
                            </div>
                        </div>
                    `;
                    return;
                }
                
                historyContainer.innerHTML = data.workflows.slice(0, 5).map(workflow => `
                    <div class="history-item">
                        <div class="history-info">
                            <div class="history-topic">${workflow.topic}</div>
                            <div class="history-meta">
                                ${workflow.workflow_type} ‚Ä¢ ${workflow.status} ‚Ä¢ ${formatDate(workflow.start_time)}
                            </div>
                        </div>
                        <div class="history-actions">
                            <span class="status-badge ${workflow.status}">${workflow.status}</span>
                            ${workflow.status === 'completed' ? 
                                `<button class="btn btn-small btn-secondary" onclick="downloadContent('${workflow.id}')">
                                    <i class="fas fa-download"></i>
                                </button>` : ''
                            }
                        </div>
                    </div>
                `).join('');
            } catch (error) {
                console.error('Failed to load workflow history:', error);
            }
        }

        function downloadContent(workflowId) {
            window.open(`/api/download-content/${workflowId}`, '_blank');
        }

        function toggleAdvanced() {
            const content = document.getElementById('advancedContent');
            const toggle = document.querySelector('.advanced-toggle');
            
            if (content.classList.contains('show')) {
                content.classList.remove('show');
                toggle.innerHTML = '<i class="fas fa-cog"></i> Advanced Options';
            } else {
                content.classList.add('show');
                toggle.innerHTML = '<i class="fas fa-cog"></i> Hide Advanced Options';
            }
        }

        function showNotification(message, type = 'info') {
            const notification = document.getElementById('notification');
            const content = document.getElementById('notificationContent');
            
            content.innerHTML = `
                <div style="display: flex; align-items: center; gap: 10px;">
                    <i class="fas fa-${type === 'success' ? 'check-circle' : 'exclamation-circle'}"></i>
                    <span>${message}</span>
                </div>
            `;
            
            notification.className = `notification ${type} show`;
            
            setTimeout(() => {
                notification.classList.remove('show');
            }, 5000);
        }

        function formatDate(dateString) {
            const date = new Date(dateString);
            return date.toLocaleString();
        }
    </script>
</body>
</html>